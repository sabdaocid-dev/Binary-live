<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Binary Live Analyzer</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0e0e10; color: #f1f1f1; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #00ffb0; }
    .box { background: #1a1a1d; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    label { display: block; margin: 10px 0 5px; }
    input, select, button, textarea { width: 100%; padding: 8px; border-radius: 5px; border: none; margin-bottom: 10px; }
    button { background: #00ffb0; color: #000; font-weight: bold; cursor: pointer; }
    button:hover { background: #00d48f; }
    pre { background: #111; padding: 10px; border-radius: 6px; color: #00ffb0; overflow-x: auto; }
  </style>
</head>
<body>

<h1>üìà Binary Live Analyzer</h1>

<div class="box">
  <label>Mode Data:</label>
  <select id="mode">
    <option value="live">Live (Binance BTC/USDT)</option>
    <option value="manual">Manual (Upload / Paste CSV)</option>
  </select>

  <label>CSV Data (jika manual):</label>
  <textarea id="csvInput" rows="5" placeholder="time,open,high,low,close"></textarea>

  <label>EMA Short / Long / RSI Period:</label>
  <input id="emaShort" type="number" value="20">
  <input id="emaLong" type="number" value="50">
  <input id="rsiPeriod" type="number" value="14">

  <label>Risk per Trade (%):</label>
  <input id="riskPct" type="number" value="2">

  <button id="btnAnalyze">üîç Analyze</button>
  <button id="btnSimulate">‚ñ∂Ô∏è Run Backtest</button>
</div>

<div class="box">
  <h3>üìä Hasil Analisis:</h3>
  <pre id="result">Belum ada analisis.</pre>
</div>

<div class="box">
  <h3>üí∞ Hasil Backtest:</h3>
  <pre id="simResult">Belum ada simulasi.</pre>
</div>

<script>
// === Fungsi ambil data live dari Binance ===
async function getLiveData(symbol = 'BTCUSDT', interval = '1m', limit = 100) {
  const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.map(d => ({
    time: new Date(d[0]).toLocaleTimeString(),
    open: parseFloat(d[1]),
    high: parseFloat(d[2]),
    low: parseFloat(d[3]),
    close: parseFloat(d[4])
  }));
}

// === Hitung EMA ===
function calcEMA(data, period) {
  let k = 2 / (period + 1);
  let emaArray = [];
  let ema = data[0];
  for (let i = 0; i < data.length; i++) {
    ema = data[i] * k + ema * (1 - k);
    emaArray.push(ema);
  }
  return emaArray;
}

// === Hitung RSI ===
function calcRSI(data, period) {
  let gains = [], losses = [];
  for (let i = 1; i < data.length; i++) {
    const diff = data[i] - data[i - 1];
    gains.push(diff > 0 ? diff : 0);
    losses.push(diff < 0 ? Math.abs(diff) : 0);
  }
  let avgGain = gains.slice(0, period).reduce((a,b)=>a+b,0)/period;
  let avgLoss = losses.slice(0, period).reduce((a,b)=>a+b,0)/period;
  let rsi = [50];
  for (let i = period; i < gains.length; i++) {
    avgGain = (avgGain * (period - 1) + gains[i]) / period;
    avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
    let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
    rsi.push(100 - (100 / (1 + rs)));
  }
  return rsi;
}

// === Analisis utama ===
function analyze(data, settings) {
  const closes = data.map(d => d.close);
  const emaShort = calcEMA(closes, settings.emaShort);
  const emaLong = calcEMA(closes, settings.emaLong);
  const rsi = calcRSI(closes, settings.rsiPeriod);

  let signals = [];
  for (let i = 1; i < data.length; i++) {
    if (emaShort[i] > emaLong[i] && rsi[i] > 55) {
      signals.push({time: data[i].time, signal: 'CALL', rsi: rsi[i]});
    } else if (emaShort[i] < emaLong[i] && rsi[i] < 45) {
      signals.push({time: data[i].time, signal: 'PUT', rsi: rsi[i]});
    }
  }
  return signals;
}

// === Simulasi sederhana ===
function simulate(signals, settings) {
  let balance = 1000;
  const risk = settings.riskPct / 100;
  const payout = 0.8;
  let wins = 0, losses = 0;

  for (let s of signals) {
    const stake = balance * risk;
    const win = Math.random() > 0.4; // simulasi random 60% win rate
    if (win) { balance += stake * payout; wins++; }
    else { balance -= stake; losses++; }
  }

  const winrate = (wins / (wins + losses)) * 100;
  return {winrate, balance, wins, losses};
}

// === Tombol ===
document.getElementById('btnAnalyze').addEventListener('click', async () => {
  const settings = {
    emaShort: +document.getElementById('emaShort').value,
    emaLong: +document.getElementById('emaLong').value,
    rsiPeriod: +document.getElementById('rsiPeriod').value,
    riskPct: +document.getElementById('riskPct').value
  };

  const mode = document.getElementById('mode').value;
  let data;
  if (mode === 'live') {
    data = await getLiveData();
  } else {
    const text = document.getElementById('csvInput').value.trim();
    data = text.split('\n').map(line => {
      const [t,o,h,l,c] = line.split(',');
      return {time:t, open:+o, high:+h, low:+l, close:+c};
    });
  }

  const result = analyze(data, settings);
  window._signals = result;
  document.getElementById('result').textContent =
    result.length ? JSON.stringify(result.slice(-10), null, 2) : "Tidak ada sinyal.";
});

document.getElementById('btnSimulate').addEventListener('click', ()=>{
  if (!window._signals) { alert('Analisis dulu!'); return; }
  const settings = {
    riskPct: +document.getElementById('riskPct').value
  };
  const sim = simulate(window._signals, settings);
  document.getElementById('simResult').textContent =
    `Total Trade: ${sim.wins+sim.losses}\nWinrate: ${sim.winrate.toFixed(2)}%\nAkhir Saldo: ${sim.balance.toFixed(2)} USD`;
});
</script>

</body>
</html>
